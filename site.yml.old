---
# Play 1: System setup
- name: Prepare System
  hosts: web
  become: true
  tasks:
    - name: Wait for cloud-init
      command: cloud-init status --wait
      changed_when: false
      ignore_errors: yes

    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install required packages
      apt:
        name:
          - nginx
          - git
          - curl
        state: present

    - name: Start and enable nginx
      systemd:
        name: nginx
        state: started
        enabled: yes

# Play 2: Deploy application
- name: Deploy Mini Finance
  hosts: web
  become: true
  tasks:
    - name: Remove old deployment if exists
      file:
        path: /tmp/mini-finance
        state: absent

    - name: Clone Mini Finance repository
      git:
        repo: https://github.com/pravinmishraaws/mini-finance.git
        dest: /tmp/mini-finance
        version: main
        force: yes
      register: git_result

    - name: Show git clone result
      debug:
        var: git_result

    - name: Verify clone succeeded
      stat:
        path: /tmp/mini-finance/index.html
      register: cloned_file

    - name: Fail if index.html not found
      fail:
        msg: "Git clone succeeded but index.html not found"
      when: not cloned_file.stat.exists

    - name: Remove default nginx content
      file:
        path: /var/www/html/index.nginx-debian.html
        state: absent

    - name: Copy application files to web root
      copy:
        src: /tmp/mini-finance/
        dest: /var/www/html/
        remote_src: yes
        owner: www-data
        group: www-data
        mode: '0755'

    - name: Verify deployment
      stat:
        path: /var/www/html/index.html
      register: deployed_file
      failed_when: not deployed_file.stat.exists

    - name: Restart nginx
      systemd:
        name: nginx
        state: restarted

# Play 3: Verification
- name: Verify Deployment
  hosts: web
  tasks:
    - name: Wait for nginx to be ready
      wait_for:
        port: 80
        delay: 2
        timeout: 30

    - name: Test HTTP response
      uri:
        url: http://localhost
        status_code: 200
        return_content: yes
      register: http_result

    - name: Show deployment info
      debug:
        msg:
          - "======================================"
          - "‚úÖ Mini Finance Deployed Successfully!"
          - "======================================"
          - "üåê Access URL: http://{{ ansible_host }}"
          - "üìä HTTP Status: {{ http_result.status }}"
          - "======================================"
